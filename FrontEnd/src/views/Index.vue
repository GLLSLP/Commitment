<template>
  <v-app id="inspire">
    <Header></Header>
    <v-main class="blue-grey lighten-5">
      <router-view
        :openWriteDialog="openWriteDialog"
        @close-write="closeWrite"
      ></router-view>
    </v-main>
    <v-btn
      fab
      large
      color="primary"
      fixed
      right
      bottom
      :ripple="false"
      @click="commit"
      :loading="!latlng || commitLoading"
      :disabled="!latlng || commitLoading || commitTimeout"
      elevation="10"
    >
      <div v-if="commitTimeout">
        <v-icon dark>mdi-lock</v-icon>
        <div>{{ min }}:{{ sec }}</div>
      </div>
      <v-icon v-else dark x-large>{{ commitBtnIcon }}</v-icon>
    </v-btn>
    <Dialog
      :alert="commitAlert"
      :alertTitle="alertTitle"
      :alertContent="alertContent"
      @close="
        commitAlert = false;
        commitLoading = false;
      "
    ></Dialog>
    <commit-complete
      :confirm="commitConfirm"
      :confirmContent="confirmContent"
      :confirmTitle="confirmTitle"
      :region="commitRegion"
      :datas="commitDatas"
      @close="
        commitConfirm = false;
        commitLoading = false;
      "
      @confirm-ok="confirmOk"
    ></commit-complete>
    
    <BadgeDialog
      :confirm="badgeflag"
      :confirmTitle="'뱃지 획득!'"
      :confirmContent="badgemsg"
      :badgename="badgename"
      :path="path"
      @close="badgeRemain()"
    ></BadgeDialog>
  </v-app>
</template>

<script>
import { addCommit, READ_PERMISSION_OK } from "../api/commit";
import { badgeCheck } from "../api/badge";
import { mapActions, mapGetters } from "vuex";
import Dialog from "../components/common/dialog/Dialog.vue";
import BadgeDialog from "../components/common/dialog/BadgeDialog.vue";
import CommitComplete from "../components/common/dialog/CommitComplete.vue";
import Header from "../components/index/Header.vue";
export default {
  components: { Dialog, CommitComplete, Header, BadgeDialog },
  name: "Index",
  computed: {
    ...mapGetters({
      latlng: ["getCurrentLatlng"],
      user: ["getUserInfo"],
      address: ["getCurrentAddress"],
      minutes: ["getMinutes"],
      seconds: ["getSeconds"],
      totalTime: ["getTotalTime"],
    }),
    min() {
      return (this.minutes < 10 ? "0" : "") + this.minutes;
    },
    sec() {
      return (this.seconds < 10 ? "0" : "") + this.seconds;
    },
  },
  watch: {
    totalTime(val) {
      if (val == 0) {
        this.STOP_TIMER();
        this.commitTimeout = false;
      }
    },
  },
  data() {
    return {
      commitBtnIcon: "mdi-map-marker-check",
      commitLoading: false,
      commitConfirm: false,
      commitAlert: false,
      confirmTitle: "커밋완료🥳",
      confirmContent: "현재 커밋에 글이나 사진을 작성할까요?",
      alertTitle: "커밋실패😰",
      alertContent: "동일한 위치는 하루에 1번만 커밋할 수 있습니다",
      openWriteDialog: false,
      commitRegion: "",
      commitDatas: "",
      commitTimeout: false,
      badgeflag: false,
      badgemsg: "",
      badgename: "",
      badgearr: [],
      badgeIndex: 0,
      path:""
    };
  },
  methods: {
    ...mapActions(["CURRENT_LATLNG", "START_TIMER", "STOP_TIMER"]),
    commit() {
      if (this.minutes != 0 || this.seconds != 0) {
        return;
      }
      this.START_TIMER();
      this.commitLoading = true;
      this.commitTimeout = true;
      addCommit(
        this.user.email,
        this.latlng.lat,
        this.latlng.lng,
        READ_PERMISSION_OK,
        (response) => {
          console.log(
            "%cIndex.vue line:115 response",
            "color: #007acc;",
            response.data
          );
          // if (response.data) {
          badgeCheck(
            this.user.email,
            (response) => {
              this.badgeIndex = 0;
              this.badgearr = response.data;
              if (this.badgearr[0].result != "yes") {
                console.log(this.badgearr[0].result);
              } else {
                console.log(this.badgearr);
                this.badgemsg = this.badgearr[0].msg;
                this.badgename = this.badgearr[0].badge;
                this.path=require('../assets/img/badge/' + this.badgename + '.png');
                console.log(this.path);
                this.badgeflag = true;
                this.badgeIndex++;
              }
            },
            (error) => {
              console.log(error);
            }
          );
          this.commitRegion = response.data.region;
          this.commitDatas = [[response.data.localX, response.data.localY, 3]];
          this.confirmContent = `[ ${this.address} ] 에서 남긴 커밋에 글이나 사진을 작성할까요?`;
          this.commitConfirm = true;
          this.openNotification(4000);
          // } else {
          //   this.alertContent = `[ ${this.address} ] 에서 이미 커밋하셨습니다. 1시간 뒤에 다시 시도해주세요.`;
          //   this.commitAlert = true;
          // }
        },
        (error) => {
          console.log(
            "%cerror Index.vue line:116 ",
            "color: red; display: block; width: 100%;",
            error
          );
          this.alertContent = `알 수 없는 오류로 커밋에 실패했습니다. 다시 시도해주세요.`;
          this.commitAlert = true;
        }
      );
    },
    openNotification(duration) {
      this.$vs.notification({
        duration,
        position: "top-right",
        color: "primary",
        flat: true,
        progress: "auto",
        title: "Commit!",
        text: `<strong>${this.address}</strong>에서 커밋했습니다.`,
      });
    },
    confirmOk() {
      this.openWriteDialog = true;
    },
    closeWrite() {
      this.openWriteDialog = false;
    },
    badgeRemain() {
      this.badgeflag = false;
      if (this.badgeIndex < this.badgearr.length) {
        this.badgemsg = this.badgearr[this.badgeIndex].msg;
        this.badgename = this.badgearr[this.badgeIndex].badge;
        this.path=require('../assets/img/badge/' + this.badgename + '.png');
        console.log(this.path);
        this.badgeflag = true;
        this.badgeIndex++;
      }
    },
  },
  created() {
    this.CURRENT_LATLNG();
  },
};
</script>

<style scoped></style>
